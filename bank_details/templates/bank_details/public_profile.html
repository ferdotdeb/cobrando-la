{% load tz %}
{% load static %}
{% load inline_svg from inline_svg %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex, noarchive" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ owner.display_name|default:owner.email }} â€” Datos de pago</title>
    <link rel="stylesheet" href="{% static 'css/public_profile.css' %}">
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <h1>Datos de pago de {{ owner.display_name|default:owner.email }}</h1>
        <div class="share-section">
          <button class="btn btn-primary" onclick="copyPublicLink()" aria-label="Compartir enlace pÃºblico">
            ðŸ“‹ Compartir enlace
          </button>
          <button class="btn" onclick="toggleQR()" aria-label="Mostrar cÃ³digo QR">
            ðŸ“± Mostrar QR
          </button>
        </div>
      </div>

      {% if details %}
        {# CLABE Section #}
        {% with clabe_items=details|dictsort:"kind"|slice:":99" %}
          {% for d in clabe_items %}
            {% if d.kind == 'CLABE' %}
              {% if forloop.first %}
              {% endif %}
              <div class="card">
                <div class="card-header">
                  <span class="kind-label">CLABE Interbancaria</span>
                  {% if d.bank_code %}
                    <span class="badge badge-code">{{ d.bank_code }}</span>
                  {% endif %}
                </div>
                {% if d.bank_name or d.alias %}
                  <div class="meta">
                    {% if d.bank_name %}{{ d.bank_name }}{% endif %}{% if d.bank_name and d.alias %} â€¢ {% endif %}{% if d.alias %}{{ d.alias }}{% endif %}
                  </div>
                {% endif %}
                <div class="value-container">
                  <div class="value" id="val-clabe-{{ forloop.counter }}">{{ d.value }}</div>
                  <button class="btn" onclick="copyText('{{ d.value }}')" aria-label="Copiar CLABE">
                    ðŸ“‹ Copiar
                  </button>
                </div>
                <div class="updated">Ãšltima actualizaciÃ³n: {% timezone "America/Mexico_City" %}{{ d.updated_at|date:"d/m/Y H:i" }}{% endtimezone %}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}

        {# Card Section #}
        {% with card_items=details|dictsort:"kind"|slice:":99" %}
          {% for d in card_items %}
            {% if d.kind == 'CARD' %}
              {% if forloop.first %}
              {% endif %}
              <div class="card">
                <div class="card-header">
                  <span class="kind-label">Tarjeta de Debito</span>
                  {% if d.brand == 'VISA' %}
                    <span class="badge badge-visa">
                      {% inline_svg 'brands/visa.svg' %}
                    </span>
                  {% elif d.brand == 'MASTERCARD' %}
                    <span class="badge badge-mastercard">
                      {% inline_svg 'brands/mc.svg' %}
                    </span>
                  {% elif d.brand %}
                    <span class="badge badge-other">{{ d.brand }}</span>
                  {% endif %}
                </div>
                {% if d.bank_name or d.alias %}
                  <div class="meta">
                    {% if d.bank_name %}{{ d.bank_name }}{% endif %}{% if d.bank_name and d.alias %} â€¢ {% endif %}{% if d.alias %}{{ d.alias }}{% endif %}
                  </div>
                {% endif %}
                <div class="value-container">
                  <div class="value" id="val-card-{{ forloop.counter }}">{{ d.value }}</div>
                  <button class="btn" onclick="copyText('{{ d.value }}')" aria-label="Copiar nÃºmero de tarjeta">
                    ðŸ“‹ Copiar
                  </button>
                </div>
                <div class="updated">Ãšltima actualizaciÃ³n: {% timezone "America/Mexico_City" %}{{ d.updated_at|date:"d/m/Y H:i" }}{% endtimezone %}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}

        {# Account Section #}
        {% with account_items=details|dictsort:"kind"|slice:":99" %}
          {% for d in account_items %}
            {% if d.kind == 'ACCOUNT' %}
              {% if forloop.first %}
                <h2 class="section-title">Cuenta</h2>
              {% endif %}
              <div class="card">
                <div class="card-header">
                  <span class="kind-label">Cuenta</span>
                </div>
                {% if d.bank_name or d.alias %}
                  <div class="meta">
                    {% if d.bank_name %}{{ d.bank_name }}{% endif %}{% if d.bank_name and d.alias %} â€¢ {% endif %}{% if d.alias %}{{ d.alias }}{% endif %}
                  </div>
                {% endif %}
                <div class="value-container">
                  <div class="value" id="val-account-{{ forloop.counter }}">{{ d.value }}</div>
                  <button class="btn" onclick="copyText('{{ d.value }}')" aria-label="Copiar nÃºmero de cuenta">
                    ðŸ“‹ Copiar
                  </button>
                </div>
                <div class="updated">Ãšltima actualizaciÃ³n: {% timezone "America/Mexico_City" %}{{ d.updated_at|date:"d/m/Y H:i" }}{% endtimezone %}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% endwith %}
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ’³</div>
          <p>AÃºn no hay datos pÃºblicos.</p>
        </div>
      {% endif %}

      <div class="footer">
        Compartido vÃ­a cobrando-la â€¢ Si estos NO son tus datos, actualÃ­zalos en tu panel.
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- QR Modal -->
    <div id="qr-modal" class="qr-modal" onclick="closeQRIfBackdrop(event)">
      <div class="qr-content">
        <button class="qr-close" onclick="toggleQR()" aria-label="Cerrar QR">Ã—</button>
        <div class="qr-title">CÃ³digo QR</div>
        <div class="qr-subtitle">Escanea para compartir este enlace</div>
        <div id="qr-container"></div>
      </div>
    </div>

    {% url 'public_profile' public_slug=owner.public_slug as public_path %}
    
    <!-- QRCode.js library (davidshimjs version) -->
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    
    <!-- Public profile script -->
    <script>
      // Set public URL as global variable for use in external script
      window.PUBLIC_URL = window.location.origin + "{{ public_path }}";
    </script>
    <script src="{% static 'js/public_profile.js' %}"></script>
  </body>
</html>
